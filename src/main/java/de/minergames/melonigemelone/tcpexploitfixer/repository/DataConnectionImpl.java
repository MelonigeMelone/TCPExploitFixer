package de.minergames.melonigemelone.tcpexploitfixer.repository;


import de.minergames.melonigemelone.tcpexploitfixer.model.MySQLValues;
import net.md_5.bungee.api.connection.ProxiedPlayer;
import org.bukkit.entity.Player;

import java.sql.*;

public class DataConnectionImpl implements DataConnection {
    private String DB_HOST;
    private String DB_USER;
    private String DB_PW;
    private String DB_DB;
    private String DB_PORT;
    private Connection connection;

    public DataConnectionImpl() {
        this.DB_HOST = MySQLValues.HOST.getValue();
        this.DB_USER = MySQLValues.USER.getValue();
        this.DB_PW = MySQLValues.PASSWORD.getValue();
        this.DB_DB = MySQLValues.DATABASE.getValue();
        this.DB_PORT = MySQLValues.PORT.getValue();

        try{
            connect();
        } catch (SQLException e) {
            System.out.println("Could not connect to Database ex: " + e.getMessage());
        } catch (ClassNotFoundException e) {
            System.out.println("Could not connect to Database - Mysql not found! ex: " + e.getMessage());
        }

    }

    /***
     * Connect to database
     * @throws ClassNotFoundException
     * @throws SQLException
     */
    private void connect() throws ClassNotFoundException, SQLException {
        if (connection != null && !connection.isClosed()) {
            return;
        }

        synchronized (this) {
            if (connection != null && !connection.isClosed()) {
                return;
            }
            Class.forName("com.mysql.jdbc.Driver");
            if(this.DB_PW == null || this.DB_PW.isEmpty() || this.DB_PW.equals("nopw")){
                System.out.println("Starting without Mysql Password!");
                connection = DriverManager.getConnection("jdbc:mysql://" + this.DB_HOST + ":" + this.DB_PORT + "/" + this.DB_DB + "?autoReconnect=true", this.DB_USER, null);
            }
            else{
                connection = DriverManager.getConnection("jdbc:mysql://" + this.DB_HOST + ":" + this.DB_PORT + "/" + this.DB_DB + "?autoReconnect=true", this.DB_USER, this.DB_PW);
            }
        }
        createTablesIfNotExist();
    }

    /***
     * Create Tables for the plugin
     * @throws SQLException
     */
    private void createTablesIfNotExist() throws SQLException {
        Statement statement = connection.createStatement();

        statement.execute("CREATE TABLE IF NOT EXISTS `tcpexploitfixer_uuids` (" +
                "  `id` int(11) unsigned NOT NULL AUTO_INCREMENT," +
                "  `uuid` varchar(64) NOT NULL DEFAULT ''," +
                "  PRIMARY KEY (`id`)\n" +
                ") ");

        statement.execute("CREATE TABLE IF NOT EXISTS `tcpexploitfixer_connections` (" +
                "  `id` int(11) unsigned NOT NULL AUTO_INCREMENT," +
                "  `uuid` varchar(64) NOT NULL DEFAULT ''," +
                "  PRIMARY KEY (`id`)\n" +
                ") ");

    }

    private void connectIfConnectionNotActive() throws SQLException {
        if(connection.isClosed()){
            try {
                connect();
            } catch (ClassNotFoundException e) {
                e.printStackTrace();
            }
        }
    }

    public void createUserDataIfNotExists(ProxiedPlayer player) {
        String uuid = player.getUniqueId().toString();

        if(!isUserDataExists(uuid)) {
            try {
                connectIfConnectionNotActive();
                PreparedStatement preparedStatement = connection.prepareStatement("INSERT INTO tcpexploitfixer_uuids (uuid) VALUES (?)");
                preparedStatement.setString(1, uuid);
                preparedStatement.executeUpdate();

            } catch (SQLException e) {
                e.printStackTrace();
            }
        }

    }

    public void deleteUserData(ProxiedPlayer p) {
        String uuid = p.getUniqueId().toString();
        if(isUserDataExists(uuid)) {
            try {
                connectIfConnectionNotActive();
                PreparedStatement preparedStatement = connection.prepareStatement("DELETE FROM tcpexploitfixer_uuids WHERE uuid = ?");
                preparedStatement.setString(1, uuid);
                preparedStatement.execute();

            } catch (SQLException e) {
                e.printStackTrace();
            }
        }
    }

    public boolean isUserDataExists(String uuid) {

        try {
            connectIfConnectionNotActive();
            PreparedStatement st = connection.prepareStatement("SELECT * FROM tcpexploitfixer_uuids WHERE uuid = ?");
            st.setString(1, uuid);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                return rs != null;
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }

        return false;

    }

    public void addConnection(Player player) {
        String uuid = player.getUniqueId().toString();

        try {
            connectIfConnectionNotActive();
            PreparedStatement preparedStatement = connection.prepareStatement("INSERT INTO tcpexploitfixer_connections (uuid) VALUES (?)");
            preparedStatement.setString(1, uuid);
            preparedStatement.executeUpdate();

        } catch (SQLException e) {
            e.printStackTrace();
        }

    }

    public boolean checkConnection(Player player) {
        String uuid = player.getUniqueId().toString();

        try {
            connectIfConnectionNotActive();
            PreparedStatement st = connection.prepareStatement("SELECT * FROM tcpexploitfixer_connections WHERE uuid = ?");
            st.setString(1, uuid);
            ResultSet rs = st.executeQuery();
            while (rs.next()) {
                return rs != null;
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }

        return false;

    }

    public void delConnection(Player player) {
        String uuid = player.getUniqueId().toString();
        try {
            connectIfConnectionNotActive();
            PreparedStatement preparedStatement = connection.prepareStatement("DELETE FROM tcpexploitfixer_connections WHERE uuid = ?");
            preparedStatement.setString(1, uuid);
            preparedStatement.execute();

        } catch (SQLException e) {
            e.printStackTrace();
        }

    }

    public void resetTables() {
        try {
            connectIfConnectionNotActive();
            PreparedStatement preparedStatement = connection.prepareStatement("DELETE FROM tcpexploitfixer_connections");
            preparedStatement.execute();
            PreparedStatement preparedStatement2 = connection.prepareStatement("DELETE FROM tcpexploitfixer_uuids");
            preparedStatement2.execute();

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }




   /* private void runAsync(final Runnable runnable){
        BukkitRunnable r = new BukkitRunnable() {
            public void run() {
                runnable.run();
            }
        };
        r.runTaskAsynchronously(PaFight.getInstance());
    }*/
}
